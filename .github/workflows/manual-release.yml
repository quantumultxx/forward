name: ğŸ”„ ç‰ˆæœ¬å‘è¡Œç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      version_mode:
        description: 'ç‰ˆæœ¬æ›´æ–°æ¨¡å¼'
        required: true
        type: choice
        options:
          - auto-patch
          - auto-minor
          - auto-major
          - manual
        default: auto-patch
      manual_version:
        description: 'æ‰‹åŠ¨ç‰ˆæœ¬å· (ä»…å½“é€‰æ‹© manual æ—¶ä½¿ç”¨ï¼Œä¾‹å¦‚: v1.0.0)'
        required: false
        type: string
        default: ''
      release_title:
        description: 'å‘å¸ƒæ ‡é¢˜'
        required: false
        type: string
        default: ''
      is_prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬?'
        required: false
        type: boolean
        default: false
      create_tag:
        description: 'æ˜¯å¦åˆ›å»º Git æ ‡ç­¾?'
        required: false
        type: boolean
        default: true

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version tag
        id: version
        run: |
          MODE="${{ github.event.inputs.version_mode }}"
          if [ "$MODE" = "manual" ]; then
            VERSION_TAG="${{ github.event.inputs.manual_version }}"
            if [ -z "$VERSION_TAG" ]; then
              echo "é”™è¯¯: æ‰‹åŠ¨æ¨¡å¼ä¸‹å¿…é¡»æä¾›ç‰ˆæœ¬å·!"
              exit 1
            fi
            if [[ ! "$VERSION_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
              echo "é”™è¯¯: ç‰ˆæœ¬æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®!"
              exit 1
            fi
          else
            LATEST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)
            if [ -z "$LATEST_TAG" ]; then
              case "$MODE" in
                auto-patch|auto-minor) VERSION_TAG="v0.1.0" ;;
                auto-major)            VERSION_TAG="v1.0.0" ;;
              esac
            else
              VERSION=${LATEST_TAG#v}
              MAJOR=$(echo $VERSION | cut -d. -f1)
              MINOR=$(echo $VERSION | cut -d. -f2)
              PATCH=$(echo $VERSION | cut -d. -f3)
              case "$MODE" in
                auto-patch) PATCH=$((PATCH + 1)) ;;
                auto-minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
                auto-major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
              esac
              VERSION_TAG="v${MAJOR}.${MINOR}.${PATCH}"
            fi
          fi
          echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT

      - name: Check if tag already exists
        run: |
          if git rev-parse "${{ steps.version.outputs.version_tag }}" >/dev/null 2>&1; then
            echo "é”™è¯¯: æ ‡ç­¾ ${{ steps.version.outputs.version_tag }} å·²å­˜åœ¨!"
            exit 1
          fi

      - name: Create Git tag
        if: github.event.inputs.create_tag == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "${{ steps.version.outputs.version_tag }}" -m "Release ${{ steps.version.outputs.version_tag }}"
          git push origin "${{ steps.version.outputs.version_tag }}"

      - name: Get Beijing time
        id: time
        run: |
          BEIJING_TIME=$(TZ="Asia/Shanghai" date +'%Y-%m-%d %H:%M:%S')
          echo "beijing_time=$BEIJING_TIME" >> $GITHUB_OUTPUT

      - name: Generate minimal changelog with latest commit only
        run: |
          LATEST_COMMIT=$(git log -1 --pretty="format:* %s (%h)")
          echo "## ${{ steps.version.outputs.version_tag }}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**å‘å¸ƒæ—¥æœŸï¼š** ${{ steps.time.outputs.beijing_time }}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "### æœ€æ–°æäº¤" >> CHANGELOG.md
          echo "$LATEST_COMMIT" >> CHANGELOG.md

      - name: Determine release title
        id: release_title
        run: |
          TITLE="${{ github.event.inputs.release_title }}"
          if [ -z "$TITLE" ]; then
            TITLE="Release ${{ steps.version.outputs.version_tag }}"
          fi
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version_tag }}
          name: ${{ steps.release_title.outputs.title }}
          body_path: CHANGELOG.md
          files: CHANGELOG.md
          prerelease: ${{ github.event.inputs.is_prerelease }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_WITH_WORKFLOW }}

      - name: Show release details
        run: |
          echo "å‘å¸ƒå·²æˆåŠŸåˆ›å»º!"
          echo "ç‰ˆæœ¬: ${{ steps.version.outputs.version_tag }}"
          echo "æ ‡é¢˜: ${{ steps.release_title.outputs.title }}"
          echo "é¢„å‘å¸ƒ: ${{ github.event.inputs.is_prerelease }}"
          echo "åŒ—äº¬æ—¶é—´: ${{ steps.time.outputs.beijing_time }}"
