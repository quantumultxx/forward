name: ğŸ”„ ç‰ˆæœ¬å›æ»šç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      rollback_type:
        description: 'å›æ»šæ–¹å¼'
        required: true
        type: choice
        options:
          - by-commit
          - by-tag
        default: by-commit
      commit_sha:
        description: '[æŒ‰æäº¤] è¦å›æ»šåˆ°çš„æäº¤ SHAï¼ˆå®Œæ•´æˆ–çŸ­ SHAï¼‰'
        required: false
        type: string
      target_tag:
        description: '[æŒ‰æ ‡ç­¾] è¦å›æ»šåˆ°çš„ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v1.0.0)'
        required: false
        type: string
      target_branch:
        description: 'è¦å›æ»šçš„ç›®æ ‡åˆ†æ”¯'
        required: true
        type: string
        default: 'main'
      rollback_version:
        description: 'æ–°å›æ»šç‰ˆæœ¬å· (ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆï¼Œä»…æ ‡ç­¾å›æ»šæ—¶ä½¿ç”¨)'
        required: false
        type: string
        default: ''
      rollback_reason:
        description: 'å›æ»šåŸå› è¯´æ˜'
        required: false
        type: string
        default: ''
      rollback_method:
        description: 'å›æ»šæ‰§è¡Œæ–¹å¼'
        required: true
        type: choice
        options:
          - revert
          - force-reset
        default: revert
      preserve_workflows:
        description: 'ä¿ç•™ .github/workflows ç›®å½•'
        required: false
        type: boolean
        default: true
      create_release:
        description: 'åˆ›å»º GitHub Release è®°å½•'
        required: false
        type: choice
        options:
          - auto
          - 'true'
          - 'false'
        default: auto
      dry_run:
        description: 'Dry-run é¢„è§ˆï¼ˆä¸æ¨é€ï¼‰'
        required: false
        type: boolean
        default: false

  schedule:
    # æ¯æœˆ 1 å· 02:30 UTCï¼ˆåŒ—äº¬æ—¶é—´ 10:30ï¼‰
    - cron: '30 2 1 * *'

permissions:
  contents: write

jobs:
  rollback:
    name: æ‰§è¡Œç‰ˆæœ¬å›æ»š
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.target_branch }}
          token: ${{ secrets.PAT_WITH_WORKFLOW }}

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Compute create_release flag
        id: release_flag
        run: |
          if [ "${{ github.event.inputs.create_release }}" = "auto" ]; then
            case "${{ github.event.inputs.rollback_type }}" in
              by-commit) echo "val=false" >> $GITHUB_OUTPUT ;;
              by-tag)    echo "val=true"  >> $GITHUB_OUTPUT ;;
            esac
          else
            echo "val=${{ github.event.inputs.create_release }}" >> $GITHUB_OUTPUT
          fi

      - name: Validate and resolve target
        id: validate
        run: |
          set -euo pipefail
          ROLLBACK_TYPE="${{ github.event.inputs.rollback_type }}"

          if [ "$ROLLBACK_TYPE" = "by-commit" ]; then
            COMMIT_SHA="${{ github.event.inputs.commit_sha }}"
            [ -z "$COMMIT_SHA" ] && { echo "é”™è¯¯: æŒ‰æäº¤å›æ»šæ—¶å¿…é¡»æä¾› commit_sha!"; exit 1; }
            if ! TARGET_COMMIT=$(git rev-parse --verify --quiet "$COMMIT_SHA^{commit}"); then
              echo "é”™è¯¯: æ— æ³•è§£ææäº¤ $COMMIT_SHA"; exit 1
            fi
            if ! git merge-base --is-ancestor "$TARGET_COMMIT" "origin/${{ github.event.inputs.target_branch }}" 2>/dev/null; then
              echo "âš ï¸  è­¦å‘Š: ç›®æ ‡æäº¤ä¸åœ¨åˆ†æ”¯ ${{ github.event.inputs.target_branch }} çš„å†å²ä¸­"
            fi
            echo "å›æ»šç›®æ ‡: æäº¤ $COMMIT_SHA"
            echo "target_type=commit" >> $GITHUB_OUTPUT
            echo "target_ref=$COMMIT_SHA" >> $GITHUB_OUTPUT
          elif [ "$ROLLBACK_TYPE" = "by-tag" ]; then
            TARGET_TAG="${{ github.event.inputs.target_tag }}"
            [ -z "$TARGET_TAG" ] && { echo "é”™è¯¯: æŒ‰æ ‡ç­¾å›æ»šæ—¶å¿…é¡»æä¾› target_tag!"; exit 1; }
            if ! git rev-parse "$TARGET_TAG" >/dev/null 2>&1; then
              echo "é”™è¯¯: æ ‡ç­¾ $TARGET_TAG ä¸å­˜åœ¨!"
              echo "å¯ç”¨çš„æ ‡ç­¾åˆ—è¡¨:"; git tag --sort=-version:refname | head -20; exit 1
            fi
            TARGET_COMMIT=$(git rev-parse "$TARGET_TAG")
            echo "å›æ»šç›®æ ‡: æ ‡ç­¾ $TARGET_TAG"
            echo "target_type=tag" >> $GITHUB_OUTPUT
            echo "target_ref=$TARGET_TAG" >> $GITHUB_OUTPUT
          fi

          echo "target_commit=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          echo "ç›®æ ‡æäº¤: $TARGET_COMMIT"
          git show -s --format='æäº¤: %H%næ—¥æœŸ: %cI%nä½œè€…: %an%nä¿¡æ¯: %s' "$TARGET_COMMIT"
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT
          echo "å½“å‰æäº¤: $CURRENT_COMMIT"
          if [ "$TARGET_COMMIT" = "$CURRENT_COMMIT" ]; then
            echo "âš ï¸  è­¦å‘Š: ç›®æ ‡æäº¤ä¸å½“å‰åˆ†æ”¯çŠ¶æ€ä¸€è‡´ï¼Œæ— éœ€å›æ»š"
            echo "needs_rollback=false" >> $GITHUB_OUTPUT
          else
            echo "needs_rollback=true" >> $GITHUB_OUTPUT
          fi

      - name: Determine rollback version tag
        if: ${{ steps.validate.outputs.target_type == 'tag' && steps.validate.outputs.needs_rollback == 'true' }}
        id: version
        run: |
          if [ -n "${{ github.event.inputs.rollback_version }}" ]; then
            ROLLBACK_TAG="${{ github.event.inputs.rollback_version }}"
            if [[ ! "$ROLLBACK_TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.]+)?$ ]]; then
              echo "é”™è¯¯: ç‰ˆæœ¬æ ‡ç­¾æ ¼å¼ä¸æ­£ç¡®!"; exit 1
            fi
          else
            LATEST_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+' | head -n 1)
            if [ -z "$LATEST_TAG" ]; then
              ROLLBACK_TAG="v1.0.0-rollback"
            else
              VERSION=${LATEST_TAG#v}; VERSION=${VERSION%%-*}
              IFS=. read -r MAJOR MINOR PATCH <<< "$VERSION"
              PATCH=$((PATCH + 1))
              ROLLBACK_TAG="v${MAJOR}.${MINOR}.${PATCH}-rollback"
            fi
          fi
          if git rev-parse "$ROLLBACK_TAG" >/dev/null 2>&1; then
            echo "é”™è¯¯: å›æ»šç‰ˆæœ¬æ ‡ç­¾ $ROLLBACK_TAG å·²å­˜åœ¨!"; exit 1
          fi
          echo "å›æ»šç‰ˆæœ¬æ ‡ç­¾: $ROLLBACK_TAG"
          echo "rollback_tag=$ROLLBACK_TAG" >> $GITHUB_OUTPUT

      - name: Get Beijing time
        id: time
        run: |
          BEIJING_TIME=$(TZ="Asia/Shanghai" date +'%Y-%m-%d %H:%M:%S %Z')
          echo "beijing_time=$BEIJING_TIME" >> $GITHUB_OUTPUT

      - name: Backup workflows
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && github.event.inputs.preserve_workflows == 'true' }}
        run: |
          echo "å¤‡ä»½å½“å‰å·¥ä½œæµæ–‡ä»¶..."
          mkdir -p /tmp/workflows_backup
          [ -d ".github/workflows" ] && cp -r .github/workflows/* /tmp/workflows_backup/ 2>/dev/null || true
          echo "å·¥ä½œæµæ–‡ä»¶å·²å¤‡ä»½åˆ° /tmp/workflows_backup"
          ls -la /tmp/workflows_backup || true

      - name: Restore workflows
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && github.event.inputs.preserve_workflows == 'true' && github.event.inputs.dry_run != 'true' }}
        run: |
          if [ -d "/tmp/workflows_backup" ] && [ -n "$(ls -A /tmp/workflows_backup 2>/dev/null)" ]; then
            echo "æ¢å¤å·¥ä½œæµæ–‡ä»¶..."
            mkdir -p .github/workflows
            cp -r /tmp/workflows_backup/* .github/workflows/ 2>/dev/null || true

            if git diff --quiet && git diff --cached --quiet; then
              echo "å·¥ä½œæµæ–‡ä»¶ä¸å›æ»šåç‰ˆæœ¬ä¸€è‡´ï¼Œæ— éœ€å†æäº¤ã€‚"
              exit 0
            fi

            git add .github/workflows
            if [ "${{ github.event.inputs.rollback_method }}" = "revert" ]; then
              git commit --amend --no-edit \
                -m "$(git log -1 --pretty=%B)" \
                -m "" \
                -m "æ³¨: å·²ä¿ç•™ .github/workflows ç›®å½•ä¸­çš„å·¥ä½œæµæ–‡ä»¶"
            else
              git commit -m "ä¿ç•™å·¥ä½œæµæ–‡ä»¶" \
                -m "å›æ»šåˆ° ${{ steps.validate.outputs.target_ref }} æ—¶ä¿ç•™äº† .github/workflows ç›®å½•"
            fi
            echo "âœ… å·¥ä½œæµæ–‡ä»¶å·²æ¢å¤å¹¶ä¿ç•™"
          else
            echo "æ²¡æœ‰å·¥ä½œæµæ–‡ä»¶éœ€è¦æ¢å¤"
          fi

      - name: Perform rollback (Revert method)
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && github.event.inputs.rollback_method == 'revert' && github.event.inputs.dry_run != 'true' }}
        run: |
          echo "ä½¿ç”¨ revert æ–¹å¼å›æ»š"
          TARGET_COMMIT="${{ steps.validate.outputs.target_commit }}"
          COMMITS_TO_REVERT=$(git rev-list $TARGET_COMMIT..HEAD)
          COMMIT_COUNT=$(echo "$COMMITS_TO_REVERT" | wc -l)
          echo "éœ€è¦ revert $COMMIT_COUNT ä¸ªæäº¤"
          if [ "$COMMIT_COUNT" -eq 0 ]; then exit 0; fi
          cat > /tmp/rollback_message.txt <<EOF
          ğŸ”„ Rollback to ${{ steps.validate.outputs.target_ref }}

          å›æ»šæ–¹å¼: ${{ github.event.inputs.rollback_type }}
          å›æ»šåŸå› : ${{ github.event.inputs.rollback_reason }}
          ç›®æ ‡å¼•ç”¨: ${{ steps.validate.outputs.target_ref }}
          å›æ»šæäº¤: ${{ steps.validate.outputs.target_commit }}
          å›æ»šæ—¶é—´: ${{ steps.time.outputs.beijing_time }}
          æ‰§è¡Œæ–¹æ³•: Revert commits

          æœ¬æ¬¡å›æ»šé€šè¿‡ revert $COMMIT_COUNT ä¸ªæäº¤å®ç°ï¼Œä¿ç•™å®Œæ•´å†å²è®°å½•ã€‚
          EOF
          if [ "$COMMIT_COUNT" -le 20 ]; then
            for commit in $COMMITS_TO_REVERT; do
              if ! git revert --no-commit $commit; then
                git revert --abort || true
                git revert --no-commit -X theirs $commit || { echo "âŒ æ— æ³•è‡ªåŠ¨è§£å†³å†²çª"; exit 1; }
              fi
            done
            git commit -F /tmp/rollback_message.txt
          else
            git reset --soft $TARGET_COMMIT
            git commit -F /tmp/rollback_message.txt
          fi

      - name: Perform rollback (Force reset method)
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && github.event.inputs.rollback_method == 'force-reset' && github.event.inputs.dry_run != 'true' }}
        run: |
          echo "âš ï¸  ä½¿ç”¨å¼ºåˆ¶é‡ç½®æ–¹å¼å›æ»š"
          echo "è¿™å°†é‡å†™åˆ†æ”¯å†å²!"
          TARGET_COMMIT="${{ steps.validate.outputs.target_commit }}"
          git reset --hard $TARGET_COMMIT

      - name: Push changes
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && github.event.inputs.dry_run != 'true' }}
        run: |
          if [ "${{ github.event.inputs.rollback_method }}" = "force-reset" ]; then
            git push --force-with-lease origin ${{ github.event.inputs.target_branch }}
          else
            git push origin ${{ github.event.inputs.target_branch }}
          fi

      - name: Create rollback tag
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && steps.validate.outputs.target_type == 'tag' && steps.release_flag.outputs.val == 'true' && github.event.inputs.dry_run != 'true' }}
        run: |
          ROLLBACK_TAG="${{ steps.version.outputs.rollback_tag }}"
          git tag -a "$ROLLBACK_TAG" \
            -m "Rollback to ${{ steps.validate.outputs.target_ref }}" \
            -m "Reason: ${{ github.event.inputs.rollback_reason }}" \
            -m "Time: ${{ steps.time.outputs.beijing_time }}"
          git push origin "$ROLLBACK_TAG"
          echo "âœ… å·²åˆ›å»ºå›æ»šæ ‡ç­¾: $ROLLBACK_TAG"

      - name: Generate rollback changelog
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && steps.release_flag.outputs.val == 'true' }}
        run: |
          echo "## ğŸ”„ ç‰ˆæœ¬å›æ»š" > ROLLBACK.md
          echo "" >> ROLLBACK.md
          if [ "${{ steps.validate.outputs.target_type }}" = "tag" ]; then
            echo "**å›æ»šç‰ˆæœ¬:** ${{ steps.version.outputs.rollback_tag }}" >> ROLLBACK.md
          fi
          echo "**å›æ»šæ–¹å¼:** ${{ github.event.inputs.rollback_type }}" >> ROLLBACK.md
          echo "**å›æ»šç›®æ ‡:** ${{ steps.validate.outputs.target_ref }}" >> ROLLBACK.md
          echo "**ç›®æ ‡åˆ†æ”¯:** ${{ github.event.inputs.target_branch }}" >> ROLLBACK.md
          echo "**å›æ»šæ—¶é—´:** ${{ steps.time.outputs.beijing_time }}" >> ROLLBACK.md
          echo "**å›æ»šæäº¤:** ${{ steps.validate.outputs.target_commit }}" >> ROLLBACK.md
          echo "**æ‰§è¡Œæ–¹æ³•:** ${{ github.event.inputs.rollback_method }}" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "### å›æ»šåŸå› " >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "${{ github.event.inputs.rollback_reason }}" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "---" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "### âœ… å›æ»šå·²å®Œæˆ" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "ä»£ç å·²æˆåŠŸå›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ã€‚" >> ROLLBACK.md
          echo "åˆ†æ”¯ \`${{ github.event.inputs.target_branch }}\` ç°åœ¨çš„ä»£ç çŠ¶æ€ä¸ç›®æ ‡ç‰ˆæœ¬å®Œå…¨ä¸€è‡´ã€‚" >> ROLLBACK.md
          if [ "${{ github.event.inputs.preserve_workflows }}" = "true" ]; then
            echo "" >> ROLLBACK.md
            echo "âš ï¸ **æ³¨æ„**: å·²ä¿ç•™ \`.github/workflows\` ç›®å½•ï¼Œå·¥ä½œæµæ–‡ä»¶ä¸å—å›æ»šå½±å“ã€‚" >> ROLLBACK.md
          fi
          echo "" >> ROLLBACK.md
          echo "---" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "### ç›®æ ‡ç‰ˆæœ¬ä¿¡æ¯" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          git show ${{ steps.validate.outputs.target_commit }} --no-patch --format="* **æäº¤:** %H%n* **æäº¤æ—¥æœŸ:** %ci%n* **æäº¤è€…:** %an%n* **æäº¤ä¿¡æ¯:** %s" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "---" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          echo "### ğŸ“ å·²å›æ»šçš„å˜æ›´" >> ROLLBACK.md
          echo "" >> ROLLBACK.md
          COMMIT_COUNT=$(git rev-list --count ${{ steps.validate.outputs.target_commit }}..${{ steps.validate.outputs.current_commit }} 2>/dev/null || echo "0")
          if [ "$COMMIT_COUNT" -gt 0 ]; then
            echo "ä»¥ä¸‹ $COMMIT_COUNT æ¬¡æäº¤å·²è¢«å›æ»š:" >> ROLLBACK.md
            echo "" >> ROLLBACK.md
            if [ "$COMMIT_COUNT" -gt 50 ]; then
              git log --oneline --pretty="format:* %s (%h)" ${{ steps.validate.outputs.target_commit }}..${{ steps.validate.outputs.current_commit }} -n 50 >> ROLLBACK.md
              echo "" >> ROLLBACK.md
              echo "*æ³¨: ä»…æ˜¾ç¤ºæœ€è¿‘50æ¬¡æäº¤ï¼Œæ€»è®¡ $COMMIT_COUNT æ¬¡å˜æ›´å·²è¢«å›æ»šã€‚*" >> ROLLBACK.md
            else
              git log --oneline --pretty="format:* %s (%h)" ${{ steps.validate.outputs.target_commit }}..${{ steps.validate.outputs.current_commit }} >> ROLLBACK.md
            fi
          fi

      - name: Create GitHub Release
        if: ${{ steps.validate.outputs.needs_rollback == 'true' && steps.validate.outputs.target_type == 'tag' && steps.release_flag.outputs.val == 'true' && github.event.inputs.dry_run != 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.rollback_tag }}
          name: "ğŸ”„ Rollback to ${{ steps.validate.outputs.target_ref }}"
          body_path: ROLLBACK.md
          files: ROLLBACK.md
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_WITH_WORKFLOW }}

      - name: Dry-run preview
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "=========================================="
          echo "ğŸ” DRY-RUN é¢„è§ˆæ¨¡å¼"
          echo "=========================================="
          echo ""
          echo "å›æ»šæ–¹å¼: ${{ github.event.inputs.rollback_type }}"
          echo "å›æ»šç›®æ ‡: ${{ steps.validate.outputs.target_ref }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          echo "æ‰§è¡Œæ–¹æ³•: ${{ github.event.inputs.rollback_method }}"
          echo "ä¿ç•™å·¥ä½œæµ: ${{ github.event.inputs.preserve_workflows }}"
          echo "åˆ›å»ºRelease: ${{ steps.release_flag.outputs.val }}"
          echo ""
          echo "ç›®æ ‡æäº¤ä¿¡æ¯:"
          git show -s --format='  æäº¤: %H%n  æ—¥æœŸ: %cI%n  ä½œè€…: %an%n  ä¿¡æ¯: %s' "${{ steps.validate.outputs.target_commit }}"
          echo ""
          if [ "${{ steps.validate.outputs.needs_rollback }}" = "true" ]; then
            COMMIT_COUNT=$(git rev-list --count ${{ steps.validate.outputs.target_commit }}..HEAD 2>/dev/null || echo "0")
            echo "å°†å›æ»š $COMMIT_COUNT ä¸ªæäº¤"
            echo ""
            echo "[DRY-RUN] æœªæ‰§è¡Œä»»ä½•æ›´æ”¹ï¼Œè¯·å–æ¶ˆ dry_run ä»¥æ‰§è¡Œå®é™…å›æ»š"
          else
            echo "âš ï¸  ç›®æ ‡æäº¤ä¸å½“å‰çŠ¶æ€ä¸€è‡´ï¼Œæ— éœ€å›æ»š"
          fi
          echo "=========================================="

      - name: Show rollback summary
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          echo "=========================================="
          if [ "${{ steps.validate.outputs.needs_rollback }}" = "true" ]; then
            echo "âœ… å›æ»šå·²æˆåŠŸå®Œæˆ!"
          else
            echo "â„¹ï¸  æ— éœ€å›æ»šï¼ˆç›®æ ‡ç‰ˆæœ¬ä¸å½“å‰çŠ¶æ€ä¸€è‡´ï¼‰"
          fi
          echo "=========================================="
          echo "å›æ»šæ–¹å¼: ${{ github.event.inputs.rollback_type }}"
          echo "å›æ»šç›®æ ‡: ${{ steps.validate.outputs.target_ref }}"
          echo "ç›®æ ‡åˆ†æ”¯: ${{ github.event.inputs.target_branch }}"
          echo "ç›®æ ‡æäº¤: ${{ steps.validate.outputs.target_commit }}"
          echo "æ‰§è¡Œæ–¹æ³•: ${{ github.event.inputs.rollback_method }}"
          echo "ä¿ç•™å·¥ä½œæµ: ${{ github.event.inputs.preserve_workflows }}"
          if [ "${{ steps.validate.outputs.target_type }}" = "tag" ] && [ "${{ steps.release_flag.outputs.val }}" = "true" ]; then
            echo "å›æ»šç‰ˆæœ¬: ${{ steps.version.outputs.rollback_tag }}"
          fi
          echo "åŒ—äº¬æ—¶é—´: ${{ steps.time.outputs.beijing_time }}"
          echo "=========================================="
          if [ "${{ steps.validate.outputs.needs_rollback }}" = "true" ]; then
            echo ""
            echo "âœ… ä»£ç å·²å›æ»šå®Œæˆ"
            echo "åˆ†æ”¯ ${{ github.event.inputs.target_branch }} ç°åœ¨çš„ä»£ç çŠ¶æ€å·²æ¢å¤åˆ°ç›®æ ‡ç‰ˆæœ¬"
            if [ "${{ github.event.inputs.preserve_workflows }}" = "true" ]; then
              echo ""
              echo "âš ï¸  å·¥ä½œæµæ–‡ä»¶å·²ä¿ç•™åœ¨æœ€æ–°ç‰ˆæœ¬ï¼Œä¸å—å›æ»šå½±å“"
            fi
          fi
          echo "=========================================="

  monthly-empty-commit:
    name: æœˆåº¦ç©ºæäº¤ï¼ˆä¿æ´»ï¼‰
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_WITH_WORKFLOW }}
          ref: main

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Create empty commit
        run: |
          git commit --allow-empty -m "chore: monthly empty commit to keep repo active [skip ci]"
          git push origin main
